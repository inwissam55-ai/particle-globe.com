<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>Super Premium Audio Reactive Particles</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<script src="https://cdn.jsdelivr.net/npm/three@0.160.0/build/three.min.js"></script>
<style>
html,body{margin:0;padding:0;overflow:hidden;background:#000;font-family:Arial,sans-serif;}
#container{position:fixed;inset:0;}
#textInput{
  position:absolute;top:30px;left:50%;transform:translateX(-50%);z-index:10;
  padding:10px 16px;font-size:16px;border-radius:8px;border:1px solid rgba(255,255,255,0.3);
  background:rgba(0,0,0,0.5);color:white;outline:none;text-align:center;
}
#controls{position:absolute;top:30px;right:30px;z-index:20;background:rgba(0,0,0,0.5);padding:10px;border-radius:10px;}
#controls select, #controls button{padding:5px;margin-left:5px;border-radius:6px;border:none;font-size:14px;cursor:pointer;}
</style>
</head>
<body>

<input id="textInput" placeholder="TYPE A WORD" maxlength="40">
<div id="controls">
  <select id="dotColor">
    <option value="0xffffff">White</option>
    <option value="0x00aaff">Blue</option>
    <option value="0xff5555">Red</option>
    <option value="0x55ff55">Green</option>
    <option value="rainbow">Rainbow</option>
  </select>
  <button id="toggleSpiral">Toggle Spiral</button>
  <button id="audioToggle">Audio: Off</button>
  <button id="asteroidToggle">Asteroid: On</button>
</div>

<div id="container"></div>
<audio id="impactSound" src="https://www.soundjay.com/explosion/sounds/explosion-01.mp3" preload="auto"></audio>

<script>
/* ---------- SCENE ---------- */
const scene = new THREE.Scene();
const camera = new THREE.PerspectiveCamera(60, innerWidth/innerHeight, 0.1, 1000);
camera.position.z = 120;

const renderer = new THREE.WebGLRenderer({antialias:true});
renderer.setSize(innerWidth, innerHeight);
renderer.setPixelRatio(Math.min(devicePixelRatio,2));
document.getElementById("container").appendChild(renderer.domElement);

/* ---------- PARTICLES ---------- */
const COUNT = 12000;
const RADIUS = 50;
const positions = new Float32Array(COUNT*3);
const original = new Float32Array(COUNT*3);
const targets = new Float32Array(COUNT*3);
const spiralTargets = new Float32Array(COUNT*3);
const velocity = new Float32Array(COUNT*3);
const colors = new Float32Array(COUNT*3);
let spiralMode = false;
let rainbowMode = false;
let asteroidMode = false;
let asteroidEnabled = true;

function createSphere(){
  for(let i=0;i<COUNT;i++){
    const theta=Math.random()*Math.PI*2;
    const phi=Math.acos(2*Math.random()-1);
    const x=RADIUS*Math.sin(phi)*Math.cos(theta);
    const y=RADIUS*Math.sin(phi)*Math.sin(theta);
    const z=RADIUS*Math.cos(phi);
    positions.set([x,y,z],i*3);
    original.set([x,y,z],i*3);
    targets.set([x,y,z],i*3);
    spiralTargets.set([x,y,z],i*3);
    velocity.set([0,0,0],i*3);
    colors[i*3]=1; colors[i*3+1]=1; colors[i*3+2]=1; 
  }
}
createSphere();

const geometry = new THREE.BufferGeometry();
geometry.setAttribute("position", new THREE.BufferAttribute(positions,3));
geometry.setAttribute("color", new THREE.BufferAttribute(colors,3));
const material = new THREE.PointsMaterial({vertexColors:true, size:0.6, transparent:true, opacity:0.9});
const points = new THREE.Points(geometry, material);
scene.add(points);

/* ---------- ASTEROID ---------- */
let asteroidMesh = null;
const asteroidGeometry = new THREE.SphereGeometry(5, 16, 16);
const asteroidMaterial = new THREE.MeshStandardMaterial({color:0x888888});
asteroidMesh = new THREE.Mesh(asteroidGeometry, asteroidMaterial);
asteroidMesh.visible = false;
scene.add(asteroidMesh);

const light = new THREE.PointLight(0xffffff,1,300);
light.position.set(0,0,100);
scene.add(light);

const impactSound = document.getElementById("impactSound");

/* ---------- TEXT TO PARTICLES ---------- */
const canvas=document.createElement("canvas");
const ctx=canvas.getContext("2d");

function reformParticles(currentText){
  asteroidMode=false;
  for(let i=0;i<COUNT;i++){
    velocity[i*3]=(Math.random()-0.5)*1;
    velocity[i*3+1]=(Math.random()-0.5)*1;
    velocity[i*3+2]=(Math.random()-0.5)*1;
  }
  mapTextToPoints(currentText);
}

function mapTextToPoints(text){
  if(!text || text.trim()===""){
    for(let i=0;i<COUNT;i++){
      targets[i*3]=original[i*3];
      targets[i*3+1]=original[i*3+1];
      targets[i*3+2]=original[i*3+2];
      velocity[i*3]=0; velocity[i*3+1]=0; velocity[i*3+2]=0;
    }
    return;
  }
  canvas.width=1200; canvas.height=200;
  ctx.clearRect(0,0,canvas.width,canvas.height);
  ctx.fillStyle="white";
  ctx.font="bold 120px Arial";
  ctx.textAlign="center"; ctx.textBaseline="middle";
  ctx.fillText(text,canvas.width/2,canvas.height/2);

  const data=ctx.getImageData(0,0,canvas.width,canvas.height).data;
  const pts=[];
  for(let y=0;y<canvas.height;y+=2){
    for(let x=0;x<canvas.width;x+=2){
      const i=(y*canvas.width+x)*4;
      if(data[i]>50) pts.push({x:(x-canvas.width/2)*0.2,y:(canvas.height/2-y)*0.2,z:(Math.random()-0.5)*5});
    }
  }

  let idx=0;
  for(let i=0;i<COUNT;i++){
    const p = pts[idx];
    velocity[i*3]=(Math.random()-0.5)*5;
    velocity[i*3+1]=(Math.random()-0.5)*5;
    velocity[i*3+2]=(Math.random()-0.5)*5;
    targets[i*3]=p.x; targets[i*3+1]=p.y; targets[i*3+2]=p.z;
    idx++; if(idx>=pts.length) idx=0;
  }

  if(spiralMode) generateSpiralTargets();
}

function textToPoints(text){
  if(!text || text.trim()===""){reformParticles(""); return;}

  if(asteroidEnabled && text.toUpperCase()==="ASTEROID"){
    asteroidMode=true;
    asteroidMesh.visible = true;
    asteroidMesh.position.set(0,50,-100);
    let startTime = Date.now();
    const asteroidSpeed = 0.5;

    const asteroidAnim = setInterval(()=>{
      const elapsed = Date.now()-startTime;
      asteroidMesh.position.y -= asteroidSpeed;
      asteroidMesh.position.z += asteroidSpeed;
      if(asteroidMesh.position.y <= 0){
        impactSound.currentTime = 0;
        impactSound.play();
        // shockwave scatter
        for(let i=0;i<COUNT;i++){
          const dx = positions[i*3]-0;
          const dy = positions[i*3+1]-0;
          const dz = positions[i*3+2]-0;
          const dist = Math.sqrt(dx*dx+dy*dy+dz*dz)+0.001;
          velocity[i*3] += dx/dist*20;
          velocity[i*3+1] += dy/dist*20;
          velocity[i*3+2] += dz/dist*20;
        }
        clearInterval(asteroidAnim);
        asteroidMesh.visible=false;
        setTimeout(()=>{
          asteroidMode=false;
          reformParticles(document.getElementById("textInput").value);
        },2000);
      }
    },16);
    return;
  }

  mapTextToPoints(text);
}

/* ---------- INPUT ---------- */
document.getElementById("textInput").addEventListener("input",e=>{
  textToPoints(e.target.value.toUpperCase());
});

/* ---------- DOT COLOR ---------- */
document.getElementById("dotColor").addEventListener("change", e=>{
  const val = e.target.value;
  rainbowMode = val==="rainbow";

  if(rainbowMode){
    for(let i=0;i<COUNT;i++){
      const hue = Math.random();
      const col = new THREE.Color();
      col.setHSL(hue,1,0.5);
      colors[i*3]=col.r; colors[i*3+1]=col.g; colors[i*3+2]=col.b;
    }
    geometry.attributes.color.needsUpdate=true;
  }else{
    const hex = Number(val);
    for(let i=0;i<COUNT;i++){
      const col = new THREE.Color(hex);
      colors[i*3]=col.r; colors[i*3+1]=col.g; colors[i*3+2]=col.b;
    }
    geometry.attributes.color.needsUpdate=true;
  }
});

/* ---------- SPIRAL TOGGLE ---------- */
document.getElementById("toggleSpiral").addEventListener("click",()=>{
  spiralMode = !spiralMode;
  generateSpiralTargets();
});

/* ---------- ASTEROID TOGGLE ---------- */
document.getElementById("asteroidToggle").addEventListener("click",()=>{
  asteroidEnabled = !asteroidEnabled;
  document.getElementById("asteroidToggle").innerText = `Asteroid: ${asteroidEnabled?"On":"Off"}`;
});

/* ---------- GENERATE SPIRAL TARGETS ---------- */
function generateSpiralTargets(){
  for(let i=0;i<COUNT;i++){
    const i3=i*3;
    const angle = i*0.05 + Date.now()*0.001;
    const radius = Math.sqrt((targets[i3])**2 + (targets[i3+1])**2);
    spiralTargets[i3] = Math.cos(angle)*radius;
    spiralTargets[i3+1] = Math.sin(angle)*radius;
    spiralTargets[i3+2] = targets[i3+2];
  }
}

/* ---------- AUDIO / MUSIC BOUNCE TOGGLE ---------- */
let audioEnabled=false;
let analyser, dataArray;
document.getElementById("audioToggle").addEventListener("click", async ()=>{
  if(audioEnabled){
    audioEnabled=false;
    document.getElementById("audioToggle").innerText = "Audio: Off";
    return;
  }
  audioEnabled=true;
  document.getElementById("audioToggle").innerText = "Audio: On";
  const stream = await navigator.mediaDevices.getUserMedia({audio:true});
  const audioCtx = new AudioContext();
  const source = audioCtx.createMediaStreamSource(stream);
  analyser = audioCtx.createAnalyser();
  analyser.fftSize = 512;
  source.connect(analyser);
  dataArray = new Uint8Array(analyser.frequencyBinCount);
});

/* ---------- MOUSE & TOUCH ---------- */
let mousePos = new THREE.Vector3(9999,9999,9999);
window.addEventListener("mousemove", e=>{updateMouse(e.clientX,e.clientY);});
window.addEventListener("touchmove", e=>{updateMouse(e.touches[0].clientX,e.touches[0].clientY);});
function updateMouse(clientX,clientY){
  const rect = renderer.domElement.getBoundingClientRect();
  const x=((clientX-rect.left)/rect.width)*2-1;
  const y=-((clientY-rect.top)/rect.height)*2+1;
  const vector=new THREE.Vector3(x,y,0.5);
  vector.unproject(camera);
  const dir = vector.clone().sub(camera.position).normalize();
  const distance=-camera.position.z/dir.z;
  mousePos = camera.position.clone().add(dir.multiplyScalar(distance));
}
window.addEventListener("mouseleave", e=>{mousePos=new THREE.Vector3(9999,9999,9999);});

/* ---------- ANIMATION ---------- */
function animate(){
  requestAnimationFrame(animate);
  const pos = geometry.attributes.position.array;

  if(audioEnabled) analyser.getByteFrequencyData(dataArray);

  for(let i=0;i<COUNT;i++){
    const i3=i*3;
    const ox=Math.sin(Date.now()*0.001+i)*0.2;
    const oy=Math.cos(Date.now()*0.001+i*0.5)*0.2;
    const oz=Math.sin(Date.now()*0.001+i*0.3)*0.2;

    let tx = spiralMode ? spiralTargets[i3] : targets[i3];
    let ty = spiralMode ? spiralTargets[i3+1] : targets[i3+1];
    let tz = spiralMode ? spiralTargets[i3+2] : targets[i3+2];

    if(asteroidMode) { 
      pos[i3]+=velocity[i3];
      pos[i3+1]+=velocity[i3+1];
      pos[i3+2]+=velocity[i3+2];
      continue;
    }

    // ---------- ENHANCED AUDIO REACTION ----------
    if(audioEnabled){
      const freq = dataArray[i % dataArray.length]/255;
      const strength = freq * 25; // bigger bounce
      if(i % 3 === 0) velocity[i3+0] += (Math.random()-0.5)*strength;
      else if(i % 3 === 1) velocity[i3+1] += (Math.random()-0.5)*strength;
      else velocity[i3+2] += (Math.random()-0.5)*strength;
    }

    // mouse repulsion
    const dx = pos[i3]-mousePos.x;
    const dy = pos[i3+1]-mousePos.y;
    const dz = pos[i3+2]-mousePos.z;
    const dist2=dx*dx+dy*dy+dz*dz;
    let repelX=0,repelY=0,repelZ=0;
    const RADIUS=8;
    if(dist2<RADIUS*RADIUS){
      const dist=Math.sqrt(dist2);
      const force=(RADIUS-dist)/RADIUS*20;
      repelX=dx/dist*force;
      repelY=dy/dist*force;
      repelZ=dz/dist*force;
    }

    velocity[i3]*=0.92; velocity[i3+1]*=0.92; velocity[i3+2]*=0.92;
    pos[i3]+=(tx+ox+repelX-pos[i3])*0.07 + velocity[i3]*0.05;
    pos[i3+1]+=(ty+oy+repelY-pos[i3+1])*0.07 + velocity[i3+1]*0.05;
    pos[i3+2]+=(tz+oz+repelZ-pos[i3+2])*0.07 + velocity[i3+2]*0.05;
  }

  geometry.attributes.position.needsUpdate=true;
  renderer.render(scene,camera);
}
animate();

/* ---------- RESIZE ---------- */
window.addEventListener("resize",()=>{
  camera.aspect=innerWidth/innerHeight;
  camera.updateProjectionMatrix();
  renderer.setSize(innerWidth,innerHeight);
});
</script>
</body>
</html>
